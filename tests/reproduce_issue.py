
import sys
import os

# Add project root to path (C:\LLM\Dev-Experimental)
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
sys.path.append(project_root)

from module.Response.ResponseDecoder import ResponseDecoder

def test_reproduce_task_85():
    # task_85 data
    src_lines_count = 128
    
    # Dummy sources (we only care about count for now, unless we do semantic matching)
    srcs = ["Source Line"] * src_lines_count
    
    # Parsed dsts from log (154 lines)
    dsts = [
      "她身上的甲胄，轻薄得近乎任性，又艳丽得扎眼。",
      "以白与蓝为主色调，装饰繁复的裙甲，乍看竟带点水手服的利落感。",
      "只是，它和米丽安的铠甲一样，用的是海龙革——那看似轻盈的质地下，藏着不容小觑的防御力。",
      "技能栏里明晃晃列着剑术技能，看来不是摆设。",
      "铠甲也不单是华丽，设计上明显考虑了大幅度的动作。正因为如此，才成了这无袖加超短裙的式样——对一位王族而言，未免太过“清凉”了些。",
      "大概是这温暖临海之国的风气吧，比起笨重的全副武装，人们更偏爱这般轻便的装束。",
      "和怎么看都只像寻常女战士的米丽安不同，这一位，你只需瞥上一眼，便能嗅出那浸在骨子里的高贵。",
      "她通身散发的气韵，明确到了这个地步。",
      "名字是赛丽梅尔·维尔梅利奥·锡德兰。",
      "她是米丽安的姐姐，也是她的主君，这身份看来确凿无疑。",
      "“让我好担心，你知道么？”",
      "“哪里的话，不过是趁着夜色潜行罢了，哪有什么危险。”",
      "“你呀，从小就是个闯祸精……以前还跑去挑衅王宫的守卫犬——”",
      "“那、那都是陈年旧事了！”",
      "“可后来，你又想偷偷骑御马厩的——”",
      "“啊啊啊！姐姐！”",
      "潜入士兵哨所、打晕守卫、放走三十多名囚犯——这也算在“闯祸”的范畴里吗？",
      "是她心胸过于宽广，还是压根没意识到其中的危险性？又或者，只是对妹妹抱有绝对的信任？",
      "或许三者皆有吧。总之，看起来不像坏人。",
      "“咳嗯。闲话稍后再叙，可否容我先引见这几位？”",
      "米丽安清了清嗓子，截断了姐姐的话头。",
      "幼时的莽撞事迹被当面揭穿，她似乎有些窘迫，脸颊泛着淡淡的红。",
      "“哎呀呀，瞧我，一不留神就说远了。叫你们见笑了？”",
      "“嗯。没关系。”",
      "芙兰还是一如既往，对谁都一个调子。这算是她的魅力所在吧……",
      "不过我这当家长的，偶尔也会希望她能多少在意一点场合啊——",
      "伦吉尔船长他们，看到芙兰对王族这般随意的态度，脸都吓白了，站在那里瑟瑟发抖。",
      "我偷眼去瞧赛丽梅尔的脸色，却没找到丝毫怒意。",
      "她看着芙兰的眼神，倒像是在打量什么可爱的小动物。幸好，是个宽厚的主儿。",
      "“呵呵，谢谢你呀。”",
      "但旁边的米丽安，显然很不痛快。",
      "“你！可知在你面前的是何等尊贵之人！”",
      "她用了类似先前那位副将军随从的台词来斥责。不过，赛丽梅尔出面袒护了。",
      "“对一个小孩子的话，何必如此敏感。”",
      "“可是，姐姐！”",
      "“这孩子是外国人，对吧？对她来说，我不过是个初次见面的阿姨呀。”",
      "“我事先告知过您王族的身份了！”",
      "“说是王族，也不过是躲藏在这种地方的、落魄的王族罢了。而且，仗着血统轻视他人，那态度不就和我那王兄一样了么？”",
      "“唔……”",
      "嗯……作为王族或许失格，但我喜欢！",
      "总觉得，她和福特王子、萨蒂雅公主有些相似。说不定能处得来。",
      "米丽安之所以愿意追随这位赛丽梅尔王女，大概也正是因为如此吧。既然主君本人都不介意，她也不好再反驳什么，只得放弃似的轻叹一口气。",
      "“唉……随您高兴吧。”",
      "“呵呵，谢谢你，米丽安。”",
      "还好，看来不会引起无谓的风波。",
      "“不过，您说她是孩子……我倒认为，这位姑娘的实力在我之上。”",
      "“哦？比米丽安还厉害？”",
      "“是。至少等级更高。而且从她的身法举止来看，武艺也相当精湛。若是正面交锋，胜负……”",
      "对了，米丽安有侦测强者的技能。看来她冷静地分析了芙兰的实力。",
      "不说“赢不了”，而说“胜负难料”——这措辞里，透着战士的自尊呢。",
      "“你真了不起呢。”",
      "赛丽梅尔对米丽安似乎抱有绝对的信任，对这判断没有丝毫怀疑。",
      "寻常人听到“这小孩比战士米丽安还强”，哪会轻易相信？",
      "她饶有兴趣地、带着欣赏的目光打量着芙兰。",
      "“嗯。”",
      "“会成为可靠的战力吧。”",
      "战力么……",
      "虽说提过要救出王子们，但这说法，听起来可不打算用温和的手段。",
      "说实话，被卷进政治斗争里，我可敬谢不敏……",
      "但确实承了她们救命之恩，光是道个谢就拍屁股走人，也未免太不识相了。",
      "更何况，芙兰那边首先就通不过。",
      "“他们说，福特和萨蒂雅被骗了。”",
      "她自己都这么主动追问了。",
      "“是那件事啊……”",
      "“是真的吗？”",
      "“嗯。千真万确。”",
      "面对芙兰的追问，赛丽梅尔神情认真地点头。",
      "“你们对这个国家的现状，了解多少呢？”",
      "“国王换了个笨蛋，情况很糟糕。”",
      "“呵呵。很精炼的总结呢。不过，能容我再稍详细说明一下吗？”",
      "“嗯。”",
      "“啊，说起来，还没正式自我介绍呢？真是失礼了。我叫赛丽梅尔·维尔梅利奥·锡德兰，是这个国家的第一王女。你的名字是？”",
      "“芙兰。黑猫族的冒险者。”",
      "“芙兰，请多关照啦？”",
      "“嗯。”",
      "芙兰之后，一直脸色发青、沉默不语的船长他们也终于开了口。",
      "虽然只报了名字，但也情有可原。他们看上去紧张得要命，这种状态下能报上名号，已经算很努力了，大叔们。",
      "起初他们好像还对让芙兰一个人应对感到过意不去，但现在似乎彻底放开了。",
      "决定了把话全权交给芙兰，自己保持沉默的策略。唉，也罢。大人们这样，真的没问题吗？",
      "“那么，我也重新自我介绍一下。我是米丽安·锡德兰。勉强算是第二王女吧。”",
      "完全不像啊。话说回来，既然是王女，为何会这么强？",
      "芙兰似乎也有同感，开口问道。",
      "“王女，却是战士？”",
      "“虽说是王女，但我是庶出。而且，打小就不擅长贵族那套玩意儿。混在战士团的训练里，反而快活得多。”",
      "“我邀她去喝茶，她也总说挥剑更有意思呢。”",
      "“那、那不是没办法嘛！说到底，我虽顶着王女的名头，却没有继承权啊。”",
      "“但再文静一些，不也挺好？”",
      "“那份优雅就拜托姐姐您了。我的人生之道，便是成为姐姐的剑，辅佐姐姐左右。故此，锻炼不可或缺。”",
      "虽是嫡女与庶女的关系，但两人感情似乎很好。",
      "话说回来，继承王位的长男是存在的吧？米丽安好像和那位关系不佳，又是为何？",
      "芙兰刚问及此事，赛丽梅尔还未开口，米丽安便沉着脸抛出一句：",
      "“因为那是个蠢货。”",
      "虽然大概能明白她想说什么，但这总结也未免太过简练。",
      "为这样的米丽安作出补充的，是赛丽梅尔。",
      "“王兄他……向来以自己的血统为傲。所以从小就对米丽安很苛刻。”",
      "“那固然是原因之一，但我追随姐姐，并非出于个人私怨。正因为我认为，像他那样粗暴、愚蠢、阴险、被选民意识禁锢的废物，不配坐上王座，我才选择追随姐姐。”",
      "措辞相当激烈，但考虑到国家的现状，或许所言不虚。",
      "照这说法，他从小就是这种德性？",
      "连年幼的妹妹都早早认定“此人不具为王器量”，这样的人，居然也能登上王位？",
      "芙兰一问，米丽安的脸色便阴沉下去。赛丽梅尔也微微蹙起了眉。",
      "显然，这对她们二人而言，也是极不情愿的事。",
      "“是啊。那么，就从那里开始说明吧。”",
      "果然，王座之事，似乎并非那么简单。",
      "“首先，王兄能成为国王的第一个理由，因为他是嫡长子。这很理所当然。”",
      "“哼。拘泥于出生顺序这种无聊事情的家伙，太多了。”",
      "喂喂，虽是庶出，但由王女来说这话真的合适吗？",
      "“而且，王兄他虽然自我中心、动辄诉诸暴力、让民众受苦、是个无可救药的人……但也并非全无优点哦？”",
      "赛丽梅尔也挺敢说的。",
      "“苏亚雷斯王兄，是我国首屈一指的战士。”",
      "“……虽不甘心，但我确实赢不了他。”",
      "哦？那可相当强了。",
      "“正因为是这样的王兄，在加冕之前，国民中也有他的支持者。”",
      "“不过，现在已经是零了。”",
      "“强大，就能当国王吗？”",
      "“在我们国家，是的。”",
      "赛丽梅尔回答了芙兰的疑问。",
      "“锡德兰的建国历史，有些特别……”",
      "她开始讲述锡德兰的建国故事。",
      "“建立锡德兰的，是海盗哦。”",
      "“海盗？海盗建立了国家？”",
      "“嗯。原本是以这座锡德兰本岛为据点横行无忌的大海盗团。王家，就是当时大船长的子孙。很厉害吧？”",
      "赛丽梅尔带着些许炫耀的神情，述说自己是海盗的后代。",
      "通常，祖上是罪犯这种事，不是该极力隐瞒吗？但赛丽梅尔和米丽安，不知为何都有些自豪。非但不以为耻，反倒引以为荣似的。",
      "仔细一问，那大海盗团似乎并未进行太过残暴的行径，而是靠开发海洋资源、强制“护送”商船等方式谋生。闲暇时，则袭击声名狼藉的军事国家的军舰，或是消灭行事不端的敌对海盗，接收其物资。",
      "热爱自由、冒险与同伴的海上豪杰——倒是很适合套用这种形象的海盗们。",
      "虽然好像也进行过掠夺，称不上善类。",
      "但至少，若放在地球的漫画里，他们多半会作为主角的友方登场吧。",
      "当然，由子孙讲述的故事，真实性有多少不得而知。",
      "这类历史记述，本就随记录者的立场而变幻莫测。搞不好，侵略行为被正当化，写成正义之举的情况也是有的。",
      "虽然不至于特意去点破这一点。但这个国家的人们，尊敬着作为先祖的海盗团，这一点是明确的。",
      "“国民们，也大多是那海盗团船员的后裔。”",
      "“正因如此，我国至今仍崇尚武勇之力。”",
      "国民之间似乎残留着海盗般的气魄。而那位活脱脱像个海盗船长、愚蠢粗暴却强大的王太子，一度也颇有人气。",
      "不过，似乎因施行恶政，那点人气也已跌入谷底。",
      "“正因是这样的国家。原本，军部的势力就很强。”",
      "“而且，军人之中，至今仍有不少王兄的支持者。王兄即位后，军费也翻倍了。”",
      "“相应地，赋税翻倍，福利等预算则被削减殆尽。”",
      "“如今留下的军人，大多是在苏亚雷斯王兄手下捞足了好处的，没办法呀。”",
      "“真是，可悲可叹！本该守护国家的军人，竟反过来苦害民众，成何体统！”",
      "向国民课以重税、使国家陷入混乱的昏君，却因为战斗力高而聚集了军人的支持？",
      "这算什么？暴走族老大吗？怎么想都是最糟糕的组合。这不就是军事独裁政权的雏形吗？",
      "“对王兄提出异议的旧部，大半遭清洗，剩下的尽是些对他唯命是从之徒。”",
      "独裁，已经开始了。",
      "“而且，身居将军之职的尤利乌斯叔父，也转而支持王兄了。”",
      "“那男人的野心昭然若揭。明显是想把愚兄当作傀儡操控吧。”",
      "“不过，王兄只要能满足自己的欲望，就很好操控。实际上，现政权能勉强维持，一半是靠尤利乌斯叔父。他比起将军，更像个官僚型的人物。虽然王兄大概没意识到这一点。”",
      "原来如此。是先王的弟弟，又身为将军的叔父在背后撑腰啊。作为支持者，分量确实足够。",
      "不过，国王的名字是苏亚雷斯，叔父的名字是尤利乌斯对吧？",
      "那不是在那黑暗奴隶商的据点里发现的、受贿者名单上的名字吗？既然是锡德兰的相关人物，应该没错了……",
      "岂止是大人物，根本就是王族啊。",
      "实际上，芙兰她们都差点被卖作奴隶了，或许现政权笼罩的黑暗，比我们想象的还要深重。",
      "“就是这样的王兄……最近，似乎频繁与雷多斯王国的使者会面。”",
      "“雷多斯王国？”",
      "赛丽梅尔说明中的一个词，让芙兰的身体，微不可察地、骤然绷紧了。"
    ]
    
    decoder = ResponseDecoder()
    print(f"Original src count: {src_lines_count}")
    print(f"Original dst count: {len(dsts)}")
    
    # Try realign
    aligned_dsts = decoder.try_realign_to_sources(dsts, srcs)
    
    print(f"Aligned dst count: {len(aligned_dsts)}")
    
    if len(aligned_dsts) == src_lines_count:
        print("SUCCESS: Line count matches.")
    else:
        print("FAILURE: Line count mismatch.")
        print(f"Diff: {len(aligned_dsts) - src_lines_count}")

def test_plain_indexed_fallback():
    response = "\n".join([
        "0: 第一行",
        "1：第二行",
        "2. 第三行",
        "3、第四行",
        "4- 第五行",
        "5: 第六行",
    ])
    decoder = ResponseDecoder()
    dsts, _ = decoder.decode(response, "")
    print(f"Indexed fallback dst count: {len(dsts)} (expect 6)")
    print("OK" if len(dsts) == 6 and dsts[0] == "第一行" and dsts[5] == "第六行" else "FAIL")

def test_thinking_indexed_fallback():
    thinking = "\n".join([
        "0: 甲",
        "1: 乙",
        "2: 丙",
        "3: 丁",
        "4: 戊",
        "5: 己",
        "6: 庚",
        "7: 辛",
        "8: 壬",
        "9: 癸",
    ]) + "\n" + ("填充" * 60)
    decoder = ResponseDecoder()
    dsts, _ = decoder.decode("", thinking)
    print(f"Thinking indexed fallback dst count: {len(dsts)} (expect 10)")
    print("OK" if len(dsts) == 10 and dsts[0] == "甲" and dsts[9].startswith("癸") else "FAIL")

if __name__ == "__main__":
    test_reproduce_task_85()
    test_plain_indexed_fallback()
    test_thinking_indexed_fallback()
